/*!
  Sqimitive.js - The Frontend Primitive
  Lightweight library to build concrete applications
  Part of Squizzle.me Toolkit  -  http://squizzle.me
  In public domain | by Proger_XP | http://proger.me
  $Id$
*/
!function(n,s){"function"==typeof define&&define.amd?define(["exports","underscore","jquery"],function(t,e,i){s(n,t,e,i)}):"undefined"!=typeof exports?s(n,exports,require("underscore"),require("jquery")):s(n,n.Sqimitive||{},n._,n.$)}(this,function(t,e,u,n){(t.Sqimitive=e).version="1.0";var r=e.Core=function(){for(var t in this._cid="p"+r.unique("p"),this)"object"!=typeof this[t]||t in this.constructor._shareProps||(this[t]=r.deepClone(this[t]))};u.extend(r,{_unique:{},_mergeProps:[],_shareProps:[],extend:function(t,e){var i=function(t,e){var i,n=this;i=t&&u.has(t,"constructor")?t.constructor:function(){return n.apply(this,arguments)},u.extend(i,n,e);var s=function(){this.constructor=i};return s.prototype=n.prototype,i.prototype=new s,t&&u.extend(i.prototype,t),i.__super__=n.prototype,i}.apply(this,arguments);t||(t={}),i._mergeProps||(i._mergeProps=this._mergeProps),i._shareProps||(i._shareProps=this._shareProps);for(var n=0,s=i._mergeProps.length;n<s;++n){var r=i._mergeProps[n];if(r in t)if(u.isArray(this.prototype[r]))Array.prototype.unshift.apply(i.prototype[r],this.prototype[r]);else for(var h in this.prototype[r])h in i.prototype[r]||(i.prototype[r][h]=this.prototype[r][h])}if("events"in(t=i.prototype)){for(var o in t._events=u.extend({},t._events),t._events)t._events[o]=t._events[o].slice();t.on.call(t,t.events),delete t.events}return i},stub:function(){},unique:function(t){return this._unique[t]=1+(this._unique[t]||0)},picker:function(e,i){return i=r.toArray(i),function(t){if(u.isObject(t)&&e in t)return"function"==typeof t[e]?t[e].apply(t,i):t[e]}},expandFunc:function(e,i){if("string"!=typeof e)return i?u.bind(e,i):e;var t=e.split(/([.-].*)/);return 1<t.length?r.masker(t[0],t[1],i):function(){var t=i||this;return t[e].apply(t,arguments)}},masker:function(n,s,r,h){var o="string"==typeof n,l="number"==typeof s||null==s;return null==s&&(s=1),h||(h=[]),l||(s=s.replace(/\./g,function(t,e){return 8<e?"-":e+1}).replace(/[^1-9.\-]+/g,"-").replace(/-+$/,"")),function(){for(var t=r||this,e=l?h.concat(u.rest(arguments,s)):h.concat(),i=0;i<s.length;i++)"-"!=s[i]&&e.push(arguments[s[i]-1]);return(o?t[n]:n).apply(t,e)}},deepClone:function(t){if(t&&"object"==typeof t)if(u.isArray(t))t=u.map(t.slice(),arguments.callee);else for(var e in t=u.extend({},t))t[e]=arguments.callee(t[e]);return t},parseEvent:function(t){var e=t.match(/^([+\-=]?)([\w\d.:+\-=]+?)(_*)$/);if(!e)throw"Bad event name: "+t;return{prefix:e[1],name:e[2],args:e[3]}},fire:function(t,n){var s;return t&&(n=arguments.length<2?[]:r.toArray(n),u.each(t.concat(),function(t){if("args"in t&&t.args!=n.length)var e=t.sup?t.sup(t.cx||this,n):void 0;else{if(t.sup||t.res){i=n.slice();t.sup&&i.unshift(t.sup),t.res&&i.unshift(s)}else var i=n;e=t.func.apply(t.cx||this,i)}t.ret&&void 0!==e&&(s=e)},this)),s},toArray:function(t){return u.isArguments(t)?Array.prototype.slice.call(t):u.isArray(t)?t:[t]},is$:function(t){return t instanceof n||n.zepto&&n.zepto.isZ(t)}}),u.extend(r.prototype,{_cid:"",_events:{},_eventsByID:{},_eventsByCx:[],_autoOff:[],_logEventID:null,fire:function(t,e){if(this._events.all&&"all"!=t){var i=arguments.length<2?[]:r.toArray(e).concat();i.unshift(t);var n=r.fire.call(this,this._events.all,i);if(void 0!==n)return n}return r.fire.call(this,this._events[t],e)},firer:function(t,e,i){return 1<arguments.length?(e=r.toArray(e),function(){return(i||this).fire(t,e.concat(Array.prototype.slice.call(arguments)))}):function(){return(i||this).fire(t,arguments)}},logEvents:function(t){if("string"!=typeof t)return!t&&arguments.length?(this.off(this._logEventID),this._logEventID=null):console&&console.log&&!this._logEventID&&(this._logEventID=this.on("all",arguments.callee)),this;var e=this._cid;if(this.el){e+="\t\t"+this.el[0].tagName;var i=this.el[0].className.trim();""!=i&&(e+=(" "+i).replace(/\s+/g,"."))}console.log(t+" ("+(arguments.length-1)+") on "+e)},on:function(t,e,i){if("object"==typeof t){for(var n in t)for(var s=n.split(", "),r=0,h=s.length;r<h;++r)this.fuse(s[r],t[n],e);return this}if(2<=arguments.length)return this._regHandler(this.fuse(t,e,i));throw"on: Bad arguments"},once:function(t,e,i){if(2<=arguments.length){var n=this.on(t,function(){if(n)return this.off(n),n=null,r.expandFunc(e,this).apply(i||this,arguments)});return n}throw"once: Bad arguments"},autoOff:function(t,e,i){if(arguments.length<1){var n=this._autoOff;return this._autoOff=[],u.invoke(n,"off",this),this}for(var s in this._autoOff.push(t),2<arguments.length||(i=this),e)for(var r=s.split(", "),h=0,o=r.length;h<o;++h)t.on(r[h],e[s],i);return t},fuse:function(t,e,i){e=r.expandFunc(e),t=r.parseEvent(t);var n=this._events[t.name]||(this._events[t.name]=[]);this._wrapHandler(t.name);var s={func:e,cx:i,event:t.name};return t.args&&(s.args=t.args.length),"+"==t.prefix?s.res=s.ret=!0:"="==t.prefix&&(s.ret=!0,s.supList=n.splice(0,n.length),s.sup=function(t,e){return u.isArguments(e)&&e[0]===arguments.callee&&(e=Array.prototype.slice.call(e,1)),r.fire.call(t,s.supList,e)}),"-"==t.prefix?n.unshift(s):n.push(s),s},_wrapHandler:function(t){if(this[t]===r.stub);else if("function"!=typeof this[t]||this[t]._wrapHandler){if(t in this)return}else this._events[t].unshift({func:this[t],ret:!0});this[t]=this.firer(t),this[t]._wrapHandler=!0},_regHandler:function(e){var t=e.id=e.event+"/"+r.unique("e");return(this._eventsByID[t]=e).cx&&(this._cxHandlers(e.cx,function(t){t.push(e)})||this._eventsByCx.push([e.cx,e])),t},_cxHandlers:function(t,e){if(t)for(var i=0,n=this._eventsByCx.length;i<n;++i)if(this._eventsByCx[i][0]===t)return e.call(this,this._eventsByCx[i],i)||!0},off:function(t){if(arguments.length<1)throw"off: Bad arguments";return u.isArray(t)?u.each(t,this.off,this):"object"==typeof t?this._cxHandlers(t,function(t,e){u.each(this._eventsByCx.splice(e,1)[0].slice(1),this._unregHandler,this)}):-1==t.indexOf("/")?u.each(this._events[t],this._unregHandler,this):this._unregHandler(this._eventsByID[t]),this},_unregHandler:function(i){if(i&&i.id){delete this._eventsByID[i.id],i.func=r.stub,this._cxHandlers(i.cx,function(t,e){t.splice(t.indexOf(i),1),t.length||this._eventsByCx.splice(e,1)});var t=(this._events[i.event]||[]).indexOf(i);if(0<=t){var e=[t,1];u.each(i.supList,function(t){t.func===r.stub||e.push(t)}),Array.prototype.splice.apply(this._events[i.event],e)}}}});var i=e.Sqimitive=r.extend({_opt:{},_firingSet:null,_parent:null,_parentKey:null,_children:{},_owning:!0,_childClass:i,_childEvents:[],_respToOpt:{},el:{tag:"div",className:""},elEvents:{},length:0,constructor:function(t){i.__super__.constructor.apply(this,arguments),this.init.apply(this,arguments),this.postInit.apply(this,arguments)},init:function(t){if(t&&t.el&&(this.el=t.el),this.el&&!r.is$(this.el))if(u.isElement(this.el)||"string"==typeof this.el)this.el=n(this.el);else{var e=u.omit(this.el,"tag","className");e.class=this.el.className||"",this.el=n(document.createElement(this.el.tag||"div")).attr(e).data("sqimitive",this)}if(this.el&&!this.el.length)throw"init: Empty el";for(var i in t)"el"==i||this.set(i,t[i])},postInit:r.stub,render:function(){return this.invoke("attach"),this},attach:function(t){if(!(t=arguments.length?n(t):[])[0]){var e=this.get("attachPath");e&&(t=this._parent?this._parent.$(e):n(e))}if(t[0]&&t[0]!==this.el[0].parentNode&&(t.append(this.el),this.invoke("attach")),this.el){var i=".sqim-"+this._cid;this.el.off(i),u.each(this.elEvents,function(t,e){t=r.expandFunc(t,this),(e=e.match(/^\s*(\S+)( .*)?$/))[1]+=i,e[2]?this.el.on(e[1],e[2],t):this.el.on(e[1],t)},this)}return this},get:function(t){return arguments.length?this._opt[t]:u.clone(this._opt)},set:function(t,e,i){return this.ifSet(t,e,i),this},ifSet:function(t,e,i){i||(i={});var n=this._opt[t],s="normalize_"+t;if(this[s]&&(e=this[s](e,i)),this._opt[t]=e,i.forceFire||!u.isEqual(e,n))return this._fireSet([t,[e,n,i]]),!0},_fireSet:function(t){if(null==this._firingSet){var e=this._firingSet=[t];try{for(;t=e.shift();)this.fire("change_"+t[0],t[1]),this.fire("change",[t[0]].concat(t[1]));this._firingSet=null}catch(t){throw this._firingSet=null,t}}else this._firingSet.push(t)},nest:function(t,e,i){if(1==arguments.length&&(e=t,t=this._defaultKey(e)),null==t||"object"==typeof t)throw"nest: bad key given";i||(i={}),t+="";var n=this._children[t];if(!(e instanceof this._childClass))throw"nest: Nesting Sqimitive of wrong class";return n!==e&&(this._owning?(n&&n.unnest(),e.unnest(),(this._children[t]=e)._parent=this,e._parentKey=t):this._children[t]=e,++this.length,this._forward(".",this._childEvents,e),this._owning&&e.owned()),e},_defaultKey:function(t){return t._cid},owned:r.stub,_forward:function(i,t,n){return u.each([].concat(t),function(t){var e=i+t;n.on(t,function(){var t=Array.prototype.slice.call(arguments);return t.unshift(n),this.fire(e,t)},this)},this),n},unlist:function(t){var e;if("object"==typeof t){for(var i in this._children)if(this._children[i]===t){e=t,t=i;break}}else e=this._children[t+""];return e&&(this._owning?e.remove():(delete this._children[t+""],--this.length,this.unnested(e))),e},unnest:function(){var t=this._parent;return t&&(delete t._children[this._parentKey],this._parent=this._parentKey=null,--t.length,t.unnested(this)),this},unnested:function(t){t.off(this),this.length<0&&console&&console.error&&console.error("Broken nesting: sqimitive.length below zero")},nested:function(t){if(!arguments.length)return u.extend({},this._children);if(null==t);else{if("object"!=typeof t)return this._children[t+""];for(var e in this._children)if(this._children[e]===t)return t}},slice:function(t,e){return 0<e&&(e+=t),Array.prototype.slice.apply(u.values(this._children),arguments)},at:function(t){return this.slice(t,1)[0]},remove:function(){return this.el&&this.el.remove(),this.unnest()},assignChildren:function(t,e){e||(e={}),e.assignChildren=!0;var i=e.eqFunc,n=e.keyFunc||this._defaultKey;if(null==i)e.keepMissing||this.each(this.unlist,this);else if("function"!=typeof i){var s=i;i=function(t,e){return e&&t.get(s)==e[s]}}t.data&&(t=t.data),u.isArray(t)||(t=u.values(t));for(var r=i?u.extend({},this._children):{},h=0;h<t.length;h++){var o=!1;for(var l in r)if(i.call(this,r[l],t[h])){r[l].assignResp(t[h],e),delete r[l],o=!0;break}if(!o){var a=(new this._childClass).assignResp(t[h],e);this.nest(n.call(this,a),a,e)}}return e.keepMissing||u.each(r,this.unlist,this),this},assignResp:function(t,e){for(var i in e||(e={}),t){var n=t[i],s=this._respToOpt[i];void 0===s&&(s=!e.onlyDefined),!0===s&&(s=i),"function"==typeof s&&(n=(s=s.call(this,n,i,t,e))[1],s=s[0]),0==s||this.set(s,n,e)}return this},bubble:function(t,e,i){return i&&this[t]&&this[t].apply(this,e),this._parent&&this._parent.bubble(t,e,!0),this},sink:function(t,e,i){return i&&this[t]&&this[t].apply(this,e),this.invoke("sink",t,e,!0),this},$:function(t){return r.is$(t)||u.isElement(t)?n(t):"body"==t?n(document.body):this.el?""==t||"."==t?this.el:this.el.find(t):n()}});(i.prototype._childClass=i)._mergeProps.push("_opt","elEvents"),i._shareProps.push("_childClass");var s=["each","map","reduce","reduceRight","find","filter","reject","every","some","contains","invoke","pluck","where","findWhere","max","min","sortBy","groupBy","indexBy","countBy","keys","pairs","pick","omit","toArray","chain","first","initial","rest","last","without","partition","difference","indexOf","shuffle","sample","lastIndexOf","sortedIndex"],h=s.indexOf("first");u.each(s,function(e){s.indexOf(e)<h?i.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(this._children),u[e].apply(u,t)}:i.prototype[e]=function(){var t=Array.prototype.slice.call(arguments);return t.unshift(u.values(this._children)),u[e].apply(u,t)}})});
